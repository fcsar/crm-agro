<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>Dashboard</h1>
      <p class="subtitle">Visão geral dos seus leads e métricas em tempo real</p>
    </div>
    <div class="header-actions">
      <button pButton icon="pi pi-refresh" label="Atualizar" class="p-button-outlined" (click)="loadDashboardData()"></button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="grid">
      <div class="col-12 md:col-6 lg:col-3" *ngFor="let i of [1, 2, 3, 4]">
        <p-skeleton height="120px"></p-skeleton>
      </div>
      <div class="col-12 md:col-6" *ngFor="let i of [1, 2]">
        <p-skeleton height="350px"></p-skeleton>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <p-message severity="error" [text]="error"></p-message>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading && !error && overview" class="dashboard-content">
    <!-- KPI Cards -->
    <div class="grid kpi-grid">
      <!-- Total Leads -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card class="kpi-card kpi-primary">
          <div class="kpi-content">
            <div class="kpi-icon">
              <i class="pi pi-users"></i>
            </div>
            <div class="kpi-details">
              <span class="kpi-label">Total de Leads</span>
              <span class="kpi-value">{{ formatNumber(overview.totalLeads) }}</span>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Prioritários -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card class="kpi-card kpi-warning">
          <div class="kpi-content">
            <div class="kpi-icon">
              <i class="pi pi-star-fill"></i>
            </div>
            <div class="kpi-details">
              <span class="kpi-label">Prioritários</span>
              <span class="kpi-value">{{ formatNumber(overview.prioritarios) }}</span>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Área Total -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card class="kpi-card kpi-success">
          <div class="kpi-content">
            <div class="kpi-icon">
              <i class="pi pi-map"></i>
            </div>
            <div class="kpi-details">
              <span class="kpi-label">Área Total (ha)</span>
              <span class="kpi-value">{{ formatDecimal(overview.totalAreaHectares || 0) }}</span>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Score Médio -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card class="kpi-card kpi-score">
          <div class="kpi-content">
            <div class="kpi-icon">
              <i class="pi pi-bolt"></i>
            </div>
            <div class="kpi-details">
              <span class="kpi-label">Score Médio</span>
              <span class="kpi-value">{{ formatDecimal(overview.averagePriorityScore) }}</span>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Taxa de Conversão -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card class="kpi-card kpi-info">
          <div class="kpi-content">
            <div class="kpi-icon">
              <i class="pi pi-chart-line"></i>
            </div>
            <div class="kpi-details">
              <span class="kpi-label">Taxa de Conversão</span>
              <span class="kpi-value">{{ formatPercentage(overview.conversionRate) }}</span>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Gráfico de Status (Pizza) -->
      <div class="chart-card">
        <p-card header="Distribuição por Status">
          <div class="chart-container">
            <p-chart
              type="pie"
              [data]="statusChartData"
              [options]="statusChartOptions"
            ></p-chart>
          </div>
        </p-card>
      </div>

      <!-- Gráfico de Origem (Barras Horizontais) -->
      <div class="chart-card">
        <p-card header="Leads por Origem">
          <div class="chart-container">
            <p-chart
              type="bar"
              [data]="originChartData"
              [options]="originChartOptions"
            ></p-chart>
          </div>
        </p-card>
      </div>

      <!-- Gráfico de Segmento (Rosquinha) -->
      <div class="chart-card">
        <p-card header="Distribuição por Segmento">
          <div class="chart-container">
            <p-chart
              type="doughnut"
              [data]="segmentChartData"
              [options]="segmentChartOptions"
            ></p-chart>
          </div>
        </p-card>
      </div>

      <!-- Gráfico de Estados (Top 5) -->
      <div class="chart-card">
        <p-card header="Top 5 Estados">
          <div class="chart-container">
            <p-chart
              type="bar"
              [data]="stateChartData"
              [options]="stateChartOptions"
            ></p-chart>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Funil de Vendas -->
    <div class="funnel-section" *ngIf="funnel && funnelChartData">
      <p-card header="Funil de Vendas">
        <div class="funnel-info mb-3">
          <p class="text-muted">
            <i class="pi pi-info-circle mr-2"></i>
            Total de leads no funil: <strong>{{ formatNumber(funnel.totalInFunnel) }}</strong>
          </p>
        </div>
        <div class="chart-container chart-container-large">
          <p-chart
            type="bar"
            [data]="funnelChartData"
            [options]="funnelChartOptions"
          ></p-chart>
        </div>
      </p-card>
    </div>

    <!-- Tabelas -->
    <div class="tables-section">
      <!-- Tabela de Cidades -->
      <div class="table-card">
        <p-card header="Top 10 Cidades">
          <p-table
            [value]="overview.leadsByCity.slice(0, 10)"
            [rows]="10"
            responsiveLayout="scroll"
            styleClass="p-datatable-sm"
          >
            <ng-template pTemplate="header">
              <tr>
                <th class="rank-col">#</th>
                <th>Cidade</th>
                <th class="text-right">Leads</th>
                <th class="text-right">% do Total</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
              <tr>
                <td class="rank-col">
                  <span class="rank-badge" [class.rank-top]="i < 3">{{ i + 1 }}</span>
                </td>
                <td>
                  <i class="pi pi-map-marker mr-2 text-primary"></i>
                  <strong>{{ item.city }}</strong>
                </td>
                <td class="text-right">
                  <span class="badge badge-primary">{{ formatNumber(item.count) }}</span>
                </td>
                <td class="text-right">
                  {{ formatPercentage((item.count / overview.totalLeads) * 100) }}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

      <!-- Tabela de Estados -->
      <div class="table-card">
        <p-card header="Leads por Estado">
          <p-table
            [value]="overview.leadsByState"
            [rows]="10"
            responsiveLayout="scroll"
            styleClass="p-datatable-sm"
          >
            <ng-template pTemplate="header">
              <tr>
                <th class="rank-col">#</th>
                <th>Estado</th>
                <th class="text-right">Leads</th>
                <th class="text-right">% do Total</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
              <tr>
                <td class="rank-col">
                  <span class="rank-badge" [class.rank-top]="i < 3">{{ i + 1 }}</span>
                </td>
                <td>
                  <i class="pi pi-globe mr-2 text-success"></i>
                  <strong>{{ item.state }}</strong>
                </td>
                <td class="text-right">
                  <span class="badge badge-success">{{ formatNumber(item.count) }}</span>
                </td>
                <td class="text-right">
                  {{ formatPercentage((item.count / overview.totalLeads) * 100) }}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>
    </div>
  </div>
</div>
