<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="properties-container">
  <!-- Header -->
  <div class="properties-header">
    <div class="header-content">
      <h1>Propriedades</h1>
      <p>Gerencie as propriedades rurais cadastradas</p>
    </div>
    <button pButton label="Nova Propriedade" icon="pi pi-plus" class="p-button-primary" (click)="showNewPropertyDialog()"></button>
  </div>

  <!-- Filters -->
  <p-card class="filters-card">
    <div class="filters-grid">
      <div class="search-field">
        <span class="p-input-icon-left">
          <input 
            type="text" 
            pInputText 
            placeholder="Buscar por cultura, cidade ou estado..."
            [(ngModel)]="searchTerm"
            (input)="applyFilters()"
            class="search-input"
          />
        </span>
      </div>
    </div>
  </p-card>

  <!-- Table -->
  <p-card class="table-card">
    <p-table 
      [value]="filteredProperties" 
      [loading]="loading"
      [lazy]="true"
      (onLazyLoad)="onPageChange($event)"
      [paginator]="true" 
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} propriedades"
      responsiveLayout="scroll"
      styleClass="p-datatable-gridlines"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Cultura</th>
          <th pSortableColumn="areaHectares">
            Área (ha) 
            <p-sortIcon field="areaHectares"></p-sortIcon>
          </th>
          <th>Localização</th>
          <th pSortableColumn="agronomicScore">
            Score Agronômico 
            <p-sortIcon field="agronomicScore"></p-sortIcon>
          </th>
          <th class="actions-column">Ações</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-property>
        <tr>
          <td>
            <div class="crops-cell">
              <p-chip [label]="getCropLabel(property.crop)" styleClass="crop-chip"></p-chip>
            </div>
          </td>
          <td>
            <span class="area-value">{{ formatNumber(property.areaHectares) }} ha</span>
          </td>
          <td>
            <div class="location-cell">
              <i class="pi pi-map-marker"></i>
              <span>{{ property.city }}/{{ property.state }}</span>
            </div>
          </td>
          <td>
            <span class="area-value">{{ formatNumber(property.agronomicScore) }}</span>
          </td>
          <td class="actions-cell">
            <button 
              pButton 
              icon="pi pi-eye" 
              class="p-button-rounded p-button-text p-button-sm"
              pTooltip="Visualizar"
              tooltipPosition="top"
              (click)="viewProperty(property)"
            ></button>
            <button 
              pButton 
              icon="pi pi-trash" 
              class="p-button-rounded p-button-text p-button-danger p-button-sm"
              pTooltip="Excluir"
              tooltipPosition="top"
              (click)="deleteProperty(property)"
            ></button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center">
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <p>Nenhuma propriedade encontrada</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Dialog de Nova Propriedade -->
<p-dialog 
  [(visible)]="displayDialog" 
  [modal]="true" 
  [style]="{width: '600px'}"
  header="Nova Propriedade"
  styleClass="p-fluid">
  
  <div class="dialog-content">
    <div class="form-grid">
      <div class="form-field full-width">
        <app-kml-upload 
          (kmlProcessed)="onKmlProcessed($event)">
        </app-kml-upload>
      </div>

      <div class="form-field full-width">
        <label for="leadId">Lead *</label>
        <select id="leadId" class="filter-select" [(ngModel)]="newProperty.leadId" [disabled]="loadingLeads">
          <option value="">Selecione um lead</option>
          <option *ngFor="let lead of leads" [value]="lead.id">
            {{ lead.name }} - {{ lead.email }}
          </option>
        </select>
      </div>

      <div class="form-field">
        <label for="crop">Cultura *</label>
        <select id="crop" class="filter-select" [(ngModel)]="newProperty.crop">
          <option *ngFor="let opt of cropOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>
      </div>

      <div class="form-field">
        <label for="area">Área (hectares) *</label>
        <input id="area" type="number" pInputText [(ngModel)]="newProperty.areaHectares" min="0" step="0.01" />
      </div>

      <div class="form-field">
        <label for="city">Cidade *</label>
        <input id="city" type="text" pInputText [(ngModel)]="newProperty.city" />
      </div>

      <div class="form-field">
        <label for="state">Estado *</label>
        <input id="state" type="text" pInputText [(ngModel)]="newProperty.state" placeholder="Ex: MG" maxlength="2" />
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayDialog = false"></button>
    <button pButton label="Salvar" icon="pi pi-check" class="p-button-primary" (click)="saveProperty()"></button>
  </ng-template>
</p-dialog>
